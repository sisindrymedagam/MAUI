<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Loop.MAUI.MainPage"
             xmlns:ctk="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             Title="Loop Kids"
             xmlns:icon="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             xmlns:vm="clr-namespace:Loop.MAUI.ViewModels"
             x:DataType="vm:ShortsViewModel"
             Shell.NavBarIsVisible="False" 
             Shell.FlyoutItemIsVisible="False" 
             Shell.TabBarIsVisible="False">

    <Grid x:Name="RootGrid">
        <Grid x:Name="VideoContainer" VerticalOptions="Center"
          HorizontalOptions="Center"
              HeightRequest="{Binding Source={x:Reference RootGrid}, Path=Height}"
          WidthRequest="{Binding Source={x:Reference RootGrid}, Path=Height, Converter={StaticResource AspectRatioConverter}, ConverterParameter=9:16}">
            <!-- Full screen video -->
            <ctk:MediaElement x:Name="Player"
                          Source="{Binding CurrentVideo.URL}"
                          ShouldAutoPlay="True"
                          ShouldLoopPlayback="True"
                              ShouldKeepScreenOn="True"
                          ShouldShowPlaybackControls="False"
                          Aspect="AspectFill"
                          VerticalOptions="Fill"
                          HorizontalOptions="Fill" />

            <!-- Fullscreen dim overlay when paused -->
            <BoxView x:Name="PauseOverlay"
                     BackgroundColor="#000000"
                     Opacity="0"
                     IsVisible="False"
                     InputTransparent="True"
                     VerticalOptions="Fill"
                     HorizontalOptions="Fill" />

            <!-- Center play icon (shown only when paused) -->
            <Image x:Name="PlayOverlay"
                   Source="{icon:Fluent Icon=PlayCircle24, IconSize=64, IconColor=#FFFFFF}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   Opacity="0"
                   IsVisible="False"/>

            
        </Grid>

        <!-- Custom transparent toolbar overlay -->
        <Grid VerticalOptions="Start"
      HeightRequest="56"
      Padding="10,0"
      BackgroundColor="Transparent">

            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#66000000" Offset="0.0" />
                    <GradientStop Color="Transparent" Offset="1.0" />
                </LinearGradientBrush>
            </Grid.Background>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Title -->
            <Label Text="Loop Kids"
           Grid.Column="0"
           TextColor="White"
           FontAttributes="Bold"
           FontSize="18"
           VerticalOptions="Center"
           HorizontalOptions="Start"/>

            <!-- Settings button -->
            <ImageButton Grid.Column="1"
                 Source="{icon:Fluent Icon=Settings20, IconSize=20, IconColor=#FFFFFF}"
                 BackgroundColor="Transparent"
                         Clicked="NavigateToSettings"
                 WidthRequest="36"
                 HeightRequest="36"
                 Padding="8"
                 VerticalOptions="Center"
                 HorizontalOptions="End"/>
        </Grid>

        <!-- Overlay bottom details -->
        <Grid VerticalOptions="End"
              BackgroundColor="Transparent">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Gradient for readability -->
            <BoxView HeightRequest="96"
                     Grid.RowSpan="1"
                     x:Name="VideoInfoBoxViewContainer"
                     VerticalOptions="End"
                     Opacity="0.4">
                <BoxView.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="Transparent" Offset="0.0" />
                        <GradientStop Color="#000000" Offset="1.0" />
                    </LinearGradientBrush>
                </BoxView.Background>
            </BoxView>

            <!-- Text overlay -->
            <VerticalStackLayout Grid.Row="0" VerticalOptions="End" Padding="10" x:Name="VideoInfoContainer">
                <Label Text="{Binding PlayPosition}"
               TextColor="White"
               FontSize="12"
               FontAttributes="Bold"
               HorizontalOptions="Start" />
                <Label Text="{Binding CurrentVideo.Name}"
                       TextColor="White"
                       x:Name="VideoTitleLabel"
                       FontSize="14"
                       Padding="0,0,0,0"
                       FontAttributes="Bold"
                       LineBreakMode="TailTruncation" />
            </VerticalStackLayout>

            <!-- Progress slider shown only when paused (at bottom of this overlay) -->
            <Grid Grid.Row="1" VerticalOptions="End"
                  HorizontalOptions="Fill"
                  IsVisible="False"
                  x:Name="ProgressContainer">
                <Slider x:Name="ProgressSlider"
                        Minimum="0"
                        MinimumTrackColor="{StaticResource PrimaryDark}"
                        MaximumTrackColor="#44FFFFFF"
                        ThumbColor="{StaticResource PrimaryDark}"
                        DragStarted="OnProgressDragStarted"
                        DragCompleted="OnProgressDragCompleted" />
            </Grid>
        </Grid>
        <!-- Attach swipe gestures to Grid (not ContentPage) -->
        <Grid.GestureRecognizers>
            <SwipeGestureRecognizer Direction="Up" Swiped="OnSwipedUp" />
            <SwipeGestureRecognizer Direction="Down" Swiped="OnSwipedDown" />
            <TapGestureRecognizer Tapped="OnVideoTapped" />
        </Grid.GestureRecognizers>
    </Grid>

</ContentPage>